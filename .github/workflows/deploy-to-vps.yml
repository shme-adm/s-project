name: Deploy to VPS

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - '**.md'
      - '.gitignore'
  workflow_dispatch:  # –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest,${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e
            
            echo "üöÄ Starting deployment..."
            
            PROJECT_DIR="/opt/portal-s"
            REPO_URL="${{ github.server_url }}/${{ github.repository }}.git"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
            if [ ! -d "$PROJECT_DIR/.git" ]; then
                echo "üì• First deployment detected - cloning repository..."
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º .env –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                if [ -f "$PROJECT_DIR/.env" ]; then
                    cp "$PROJECT_DIR/.env" /tmp/.env.backup
                    echo "üíæ .env backed up"
                fi
                
                # –û—á–∏—â–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                if [ -d "$PROJECT_DIR" ]; then
                    rm -rf "$PROJECT_DIR"
                fi
                
                # –°–æ–∑–¥–∞–µ–º –∏ –∫–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
                mkdir -p "$PROJECT_DIR"
                cd "$PROJECT_DIR"
                git clone "$REPO_URL" .
                echo "‚úÖ Repository cloned successfully"
                
                # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .env –µ—Å–ª–∏ –º—ã –µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏
                if [ -f /tmp/.env.backup ]; then
                    cp /tmp/.env.backup "$PROJECT_DIR/.env"
                    rm /tmp/.env.backup
                    echo "‚úÖ .env restored"
                fi
            else
                echo "‚úÖ Repository exists - updating..."
                cd "$PROJECT_DIR"
                git fetch origin main
                git checkout main
                git pull origin main
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞
            if [ ! -f ".env" ]; then
                echo "‚ùå ERROR: .env file not found in $PROJECT_DIR"
                echo "‚ö†Ô∏è First deployment requires .env file to be placed on server"
                exit 1
            fi
            
            echo "‚úÖ .env file found"
            
            # –õ–æ–≥–∏—Ä—É–µ–º—Å—è –≤ container registry
            if [ ! -z "${{ secrets.GHCR_TOKEN }}" ]; then
                echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            else
                echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            fi
            
            # –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
            mkdir -p logs
            mkdir -p client/node_modules
            mkdir -p server/node_modules
            
            # –í—ã—Ç—è–≥–∏–≤–∞–µ–º –æ–±—Ä–∞–∑—ã
            echo "üì¶ Pulling images..."
            docker compose pull || true

            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "‚èπÔ∏è Stopping old containers..."
            docker compose down || true
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "üê≥ Starting containers..."
            docker compose up -d --build
            
            # –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ –æ—á–∏—â–∞–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ä–µ—Å—É—Ä—Å—ã
            echo "üßπ Pruning Docker resources..."
            docker system prune -af
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–≤–∏—Å–∞
            echo "üîç Checking service health (max 30 attempts)..."
            MAX_ATTEMPTS=30
            ATTEMPT=1
            
            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
                echo "‚úÖ API is healthy"
                break
              fi
              
              if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
                echo "‚ö†Ô∏è API health check failed after $MAX_ATTEMPTS attempts"
                echo "üìä Container status:"
                docker compose ps
                break
              fi
              
              echo "‚è≥ Attempt $ATTEMPT/$MAX_ATTEMPTS..."
              sleep 2
              ATTEMPT=$((ATTEMPT + 1))
            done
            
            echo ""
            echo "üìä Container status:"
            docker compose ps
            
            echo "‚úÖ Deployment completed successfully!"

      - name: Notify on success
        if: success()
        run: |
          echo "‚úÖ Deployment successful!"
          echo "üåê Application deployed at: https://${{ secrets.VPS_DOMAIN }}"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "Check GitHub Actions logs for details"
