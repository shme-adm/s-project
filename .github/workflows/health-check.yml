name: Health Check

on:
  #schedule:
  #  # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —á–∞—Å
  #  - cron: '0 * * * *'
  workflow_dispatch:  # –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check API Health
        run: |
          echo "üîç Checking API health..."
          
          API_URL="${{ secrets.VPS_DOMAIN || 'localhost:3000' }}"
          
          # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ API
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://$API_URL/api/health || echo "000")
          
          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ API is healthy (HTTP $RESPONSE)"
            exit 0
          else
            echo "‚ö†Ô∏è API returned HTTP $RESPONSE"
            exit 1
          fi

      - name: SSH check services on VPS
        if: failure()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            echo "üîç Checking services..."
            docker ps -a
            echo ""
            echo "üìã Recent logs:"
            docker compose logs backend | tail -20
