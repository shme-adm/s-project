name: Deploy to Production

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script_stop_on_error: true
          script: |
            set -e
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ environment
            if [ "${{ github.event.inputs.environment }}" = "staging" ]; then
              PROJECT_DIR="/opt/portal-s-staging"
              COMPOSE_FILE="docker-compose.staging.yml"
            else
              PROJECT_DIR="/opt/portal-s"
              COMPOSE_FILE="docker-compose.yml"
            fi
            
            echo "üöÄ Deploying to ${{ github.event.inputs.environment || 'production' }}..."
            cd $PROJECT_DIR
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            git fetch origin
            git checkout ${{ github.ref_name }}
            git pull origin ${{ github.ref_name }}
            
            # –õ–æ–≥–∏—Ä—É–µ–º—Å—è –≤ registry
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è
            if [ -f "./scripts/migrate.sh" ]; then
              echo "üîÑ Running migrations..."
              bash ./scripts/migrate.sh
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º .env
            if [ ! -f ".env" ]; then
              echo "‚ö†Ô∏è .env file not found, creating from .env.example"
              cp .env.example .env 2>/dev/null || echo "No .env.example found"
            fi
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "‚èπÔ∏è Stopping old containers..."
            docker compose -f $COMPOSE_FILE down --remove-orphans || true
            
            # –í—ã—Ç—è–≥–∏–≤–∞–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑
            echo "üì¶ Pulling Docker image..."
            docker pull ghcr.io/${{ github.repository }}:${{ github.sha }}
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å –Ω–æ–≤—ã–º –æ–±—Ä–∞–∑–æ–º
            echo "üê≥ Starting containers..."
            docker compose -f $COMPOSE_FILE up -d --pull=always
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ
            echo "üîç Waiting for services to be healthy..."
            sleep 15
            
            MAX_ATTEMPTS=30
            ATTEMPT=0
            while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
              if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
                echo "‚úÖ Services are healthy"
                break
              fi
              ATTEMPT=$((ATTEMPT + 1))
              if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
                echo "‚ö†Ô∏è Health check timeout, but containers are running"
                docker compose logs backend | tail -20
                break
              fi
              echo "Waiting for services... ($ATTEMPT/$MAX_ATTEMPTS)"
              sleep 2
            done
            
            # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ä–µ—Å—É—Ä—Å—ã
            docker system prune -f --volumes
            
            echo "‚úÖ Deployment completed!"
            
      - name: Send Slack notification
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "Portal S Deployment ${{ job.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Portal S Deployment*\nEnvironment: ${{ github.event.inputs.environment || 'production' }}\nStatus: ${{ job.status }}\nCommit: ${{ github.sha }}"
                  }
                }
              ]
            }
